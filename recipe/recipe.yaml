schema_version: 1

context:
  name: python-cudnn-frontend
  version: "1.16.1"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://github.com/NVIDIA/cudnn-frontend/archive/v${{ version }}.tar.gz
  sha256: a1550de474e64e6f97ccae2c76c7abaac593b7b54fafaa309b743cb70ac68305

build:
  number: 0
  string: cuda${{ cuda_compiler_version | replace('.', '') }}py${{ CONDA_PY }}h${{ PKG_HASH }}_${{ PKG_BUILDNUM }}
  skip: cuda_compiler_version in (undefined, "None") or (not linux)
  script:
    env:
      CUDNN_FRONTEND_LOG_INFO: "1"
    content:
      - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
    - ${{ compiler('cuda') }}
    - ${{ stdlib("c") }}
    - cmake >=3.18
    - make
    - ninja
  host:
    - cudnn
    - pip
    - pybind11
    - python
    - setuptools >=64
  run:
    - python

tests:
  - python:
      imports:
        - cudnn
        # - cudnn.gemm_swiglu
        # - cudnn.gemm_amax
      pip_check: true
  - requirements:
      run:
        - pip
        # - nvidia-cutlass-dsl
    script:
      - python -c "import cudnn; assert cudnn.backend_version() >= 91000, cudnn.backend_version()"

      # PY_VER is not available in 'tests' section with rattler-build
      - export PY_VER=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
      - ls -lh $PREFIX/lib/python$PY_VER/site-packages/include/*
      - test -f $PREFIX/lib/python$PY_VER/site-packages/include/cudnn_frontend.h

about:
  summary: cuDNN FrontEnd API
  license: MIT
  license_file:
    - LICENSE.txt
    - include/cudnn_frontend/thirdparty/nlohmann/LICENSE.MIT
  homepage: https://github.com/NVIDIA/cudnn-frontend

extra:
  recipe-maintainers:
    - weiji14
